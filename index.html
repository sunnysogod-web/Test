<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;family=Fredoka:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .app-wrapper { height: 100%; width: 100%; overflow-y: auto; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.6s ease-out; }
    .loading-spin { animation: spin 1s linear infinite; }
    
    .input-field {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.875rem;
      font-family: 'Prompt', sans-serif;
      font-size: 15px;
      color: #1e293b;
      transition: all 0.3s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-primary {
      padding: 0.875rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Fredoka', sans-serif;
      font-size: 15px;
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }
    
    .btn-approve {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .btn-approve:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    }
    
    .btn-reject {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    .btn-reject:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
    }
    
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .toast {
      padding: 1rem 1.5rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-weight: 600;
      animation: fadeIn 0.3s ease;
    }
    
    .toast-success { background: #10b981; color: white; }
    .toast-error { background: #ef4444; color: white; }
    .toast-info { background: #3b82f6; color: white; }
    
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .request-card {
      background: white;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .request-card.pending {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    
    .request-card.approved {
      border-left-color: #10b981;
      background: #f0fdf4;
    }
    
    .request-card.rejected {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .drop-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .drop-zone:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .drop-zone.drag-over {
      border-color: #667eea;
      background: #f0f4ff;
      transform: scale(1.02);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-wrapper">
   <div id="toast-container" class="fixed top-6 right-6 z-50 space-y-2 pointer-events-none"></div><!-- LOGIN PAGE -->
   <div id="login-page" class="min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md fade-in">
     <div class="text-center mb-12">
      <div class="w-20 h-20 bg-white rounded-full mx-auto mb-6 flex items-center justify-center shadow-lg"><span class="text-5xl">üè´</span>
      </div>
      <h1 class="text-4xl font-bold text-white mb-2" style="font-family: 'Fredoka';">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</h1>
      <p class="text-purple-100">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏¢‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</p>
     </div>
     <div class="card p-8">
      <div class="flex gap-0 bg-gray-100 rounded-lg mb-6 overflow-hidden"><button onclick="selectRole('student')" class="role-btn flex-1 py-3 font-bold text-center text-gray-700 bg-white transition-all" id="role-student">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button> <button onclick="selectRole('staff')" class="role-btn flex-1 py-3 font-bold text-center text-gray-600 transition-all" id="role-staff">üë®‚Äçüíº ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
      </div>
      <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
       <div><label class="block text-sm font-bold text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label> <input type="text" id="login-id" required class="input-field w-full" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™">
       </div>
       <div><label class="block text-sm font-bold text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="login-password" required class="input-field w-full" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
       </div><button type="submit" class="btn-primary btn-submit w-full mt-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
      <div class="mt-6 p-3 bg-blue-50 rounded-lg border border-blue-200 text-xs">
       <p class="font-bold text-blue-900 mb-1">üìã ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</p>
       <p class="text-blue-800">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ID + <strong>1234</strong></p>
       <p class="text-blue-800">üëî ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: <strong>admin</strong> / <strong>admin123</strong></p>
      </div>
     </div>
    </div>
   </div><!-- STUDENT DASHBOARD -->
   <div id="student-dash" style="display: none;">
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white sticky top-0 z-20">
     <div class="max-w-6xl mx-auto px-4 py-6 flex justify-between items-center">
      <div class="flex items-center gap-3"><span class="text-3xl">üè´</span>
       <div>
        <h1 class="font-bold text-xl" style="font-family: 'Fredoka';">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</h1>
        <p class="text-purple-100 text-sm">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
       </div>
      </div><button onclick="logout()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold text-sm transition-all">‡∏≠‡∏≠‡∏Å</button>
     </div>
    </div>
    <div class="max-w-6xl mx-auto p-6 space-y-6 pb-12"><!-- Stats -->
     <div class="grid md:grid-cols-3 gap-4">
      <div class="card p-4">
       <p class="text-sm font-bold text-gray-600 mb-1">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
       <p class="text-3xl font-bold text-amber-600" id="stat-pending-student">0</p>
      </div>
      <div class="card p-4">
       <p class="text-sm font-bold text-gray-600 mb-1">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
       <p class="text-3xl font-bold text-green-600" id="stat-approved-student">0</p>
      </div>
      <div class="card p-4">
       <p class="text-sm font-bold text-gray-600 mb-1">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
       <p class="text-3xl font-bold text-red-600" id="stat-rejected-student">0</p>
      </div>
     </div><!-- Form -->
     <div class="card p-8 fade-in">
      <h2 class="text-2xl font-bold text-gray-800 mb-6" style="font-family: 'Fredoka';">üìù ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</h2>
      <form id="student-form" onsubmit="submitRequest(event)" class="space-y-6">
       <div class="grid md:grid-cols-3 gap-4">
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label> <input type="text" id="form-name" required class="input-field w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        </div>
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡∏ä‡∏±‡πâ‡∏ô *</label> <select id="form-level" required class="input-field w-full"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô --</option> <option value="‡∏°.1">‡∏°.1</option> <option value="‡∏°.2">‡∏°.2</option> <option value="‡∏°.3">‡∏°.3</option> <option value="‡∏°.4">‡∏°.4</option> <option value="‡∏°.5">‡∏°.5</option> <option value="‡∏°.6">‡∏°.6</option> </select>
        </div>
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡∏´‡πâ‡∏≠‡∏á *</label> <select id="form-room" required class="input-field w-full"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> </select>
        </div>
       </div>
       <div class="grid md:grid-cols-3 gap-4">
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤ *</label> <input type="date" id="form-date" required class="input-field w-full">
        </div>
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å *</label> <input type="time" id="form-leave-time" required class="input-field w-full">
        </div>
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö</label> <input type="time" id="form-return-time" class="input-field w-full">
        </div>
       </div>
       <div class="grid md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á *</label> <input type="text" id="form-parent-name" required class="input-field w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">
        </div>
        <div><label class="block text-sm font-bold text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label> <input type="tel" id="form-parent-phone" required class="input-field w-full" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
        </div>
       </div>
       <div><label class="block text-sm font-bold text-gray-700 mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ *</label> <textarea id="form-reason" required class="input-field w-full h-24 resize-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πà‡∏ß‡∏¢ ‡∏ò‡∏∏‡∏£‡∏∞‡∏î‡πà‡∏ß‡∏ô..."></textarea>
       </div><!-- Photo Upload -->
       <div><label class="block text-sm font-bold text-gray-700 mb-2">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ </label>
        <div class="drop-zone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('photo-input').click()">
         <div class="text-4xl mb-2">
          üì∏
         </div>
         <p class="text-gray-700 font-semibold">‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
         <p class="text-sm text-gray-500">‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
        </div><input type="file" id="photo-input" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
        <div id="photo-preview" class="mt-4 rounded-lg overflow-hidden" style="display: none;"><img id="preview-img" src="" style="width: 100%; height: auto; max-height: 300px; object-fit: cover;"> <button type="button" onclick="removePhoto()" class="w-full bg-red-500 text-white py-2 font-bold hover:bg-red-600 mt-2">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
        </div>
       </div><button type="submit" id="submit-btn" class="btn-primary btn-submit w-full">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
      </form>
     </div><!-- History -->
     <div class="card p-8 fade-in">
      <h2 class="text-2xl font-bold text-gray-800 mb-4" style="font-family: 'Fredoka';">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
      <div id="student-history" class="space-y-3">
       <p class="text-center text-gray-400 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
      </div>
     </div>
    </div>
   </div><!-- STAFF DASHBOARD -->
   <div id="staff-dash" style="display: none;">
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white sticky top-0 z-20">
     <div class="max-w-7xl mx-auto px-4 py-6 flex justify-between items-center">
      <div class="flex items-center gap-3"><span class="text-3xl">üè´</span>
       <div>
        <h1 class="font-bold text-xl" style="font-family: 'Fredoka';">‡πÅ‡∏ú‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h1>
        <p class="text-purple-100 text-sm">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
       </div>
      </div><button onclick="logout()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold text-sm transition-all">‡∏≠‡∏≠‡∏Å</button>
     </div>
    </div>
    <div class="max-w-7xl mx-auto p-6 space-y-6 pb-12">
     <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="card p-4">
       <p class="text-xs font-bold text-gray-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
       <p class="text-2xl font-bold text-blue-600" id="stat-total">0</p>
      </div>
      <div class="card p-4">
       <p class="text-xs font-bold text-gray-600">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
       <p class="text-2xl font-bold text-amber-600" id="stat-pending">0</p>
      </div>
      <div class="card p-4">
       <p class="text-xs font-bold text-gray-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
       <p class="text-2xl font-bold text-green-600" id="stat-approved">0</p>
      </div>
      <div class="card p-4">
       <p class="text-xs font-bold text-gray-600">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
       <p class="text-2xl font-bold text-red-600" id="stat-rejected">0</p>
      </div>
     </div>
     <div class="card p-3 sticky top-20 z-10 flex gap-2 overflow-x-auto"><button onclick="filterRequests('all')" class="filter-btn flex-1 py-2 px-3 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-semibold text-sm whitespace-nowrap">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button> <button onclick="filterRequests('pending')" class="filter-btn flex-1 py-2 px-3 rounded-lg text-gray-700 hover:bg-gray-100 font-semibold text-sm whitespace-nowrap">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button> <button onclick="filterRequests('approved')" class="filter-btn flex-1 py-2 px-3 rounded-lg text-gray-700 hover:bg-gray-100 font-semibold text-sm whitespace-nowrap">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button> <button onclick="filterRequests('rejected')" class="filter-btn flex-1 py-2 px-3 rounded-lg text-gray-700 hover:bg-gray-100 font-semibold text-sm whitespace-nowrap">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
     </div>
     <div id="staff-requests" class="space-y-4">
      <p class="text-center text-gray-400 py-12">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
     </div>
    </div>
   </div><!-- Rejection Modal -->
   <div id="rejection-modal" style="display: none;" class="fixed inset-0 modal-overlay z-40 flex items-center justify-center p-4">
    <div class="card p-6 max-w-md w-full">
     <h3 class="text-lg font-bold text-red-600 mb-4">‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</h3><textarea id="rejection-text" class="input-field w-full h-20 resize-none mb-4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."></textarea>
     <div class="flex gap-2"><button onclick="closeRejectionModal()" class="flex-1 btn-primary bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button> <button onclick="submitRejection()" class="flex-1 btn-primary btn-reject">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
     </div>
    </div>
   </div><!-- Photo Modal -->
   <div id="photo-modal" style="display: none;" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
    <div class="relative max-w-3xl w-full"><button onclick="closePhotoModal()" class="absolute -top-10 right-0 bg-white text-gray-800 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold hover:bg-gray-200">‚úï</button> <img id="modal-photo" src="" alt="Full photo" class="w-full h-auto rounded-lg shadow-2xl">
    </div>
   </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCm9QsD6NwRF0zusMzgESEyA43hjEyHRhw",
      authDomain: "sw-website-68.firebaseapp.com",
      projectId: "sw-website-68",
      storageBucket: "sw-website-68.firebasestorage.app",
      messagingSenderId: "728405606506",
      appId: "1:728405606506:web:28d2f983c552a118e9397c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;
    let currentRole = null;
    let currentFilter = 'all';
    let rejectionId = null;
    let allRequests = [];
    let unsubscribe = null;
    let photoFile = null;
    let isSubmitting = false;

    function showToast(msg, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function selectRole(role) {
      currentRole = role;
      document.getElementById('role-student').style.background = role === 'student' ? 'white' : '#f3f4f6';
      document.getElementById('role-student').style.color = role === 'student' ? '#667eea' : '#666';
      document.getElementById('role-staff').style.background = role === 'staff' ? 'white' : '#f3f4f6';
      document.getElementById('role-staff').style.color = role === 'staff' ? '#667eea' : '#666';
    }

    function handleLogin(e) {
      e.preventDefault();
      const id = document.getElementById('login-id').value.trim();
      const pass = document.getElementById('login-password').value;

      if (!currentRole) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó', 'error');
        return;
      }

      if (currentRole === 'student') {
        if (pass !== '1234') {
          showToast('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
          return;
        }
        currentUser = { userId: id, name: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', role: 'student' };
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('student-dash').style.display = 'block';
        document.getElementById('staff-dash').style.display = 'none';
        showToast('‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!');
        setTimeout(() => loadStudentHistory(), 300);
      } else {
        if (id !== 'admin' || pass !== 'admin123') {
          showToast('‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
          return;
        }
        currentUser = { userId: id, name: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà', role: 'staff' };
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('staff-dash').style.display = 'block';
        document.getElementById('student-dash').style.display = 'none';
        showToast('‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!');
        setTimeout(() => listenToRequests(), 300);
      }
    }

    function logout() {
      if (unsubscribe) unsubscribe();
      currentUser = null;
      photoFile = null;
      isSubmitting = false;
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('student-dash').style.display = 'none';
      document.getElementById('staff-dash').style.display = 'none';
      document.getElementById('login-form').reset();
      selectRole('student');
      showToast('üëã ‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    async function loadStudentHistory() {
      try {
        const snap = await db.collection('leaveRequests')
          .where('studentId', '==', currentUser.userId)
          .orderBy('createdAt', 'desc')
          .get();
        
        const requests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const pending = requests.filter(r => r.status === 'pending').length;
        const approved = requests.filter(r => r.status === 'approved').length;
        const rejected = requests.filter(r => r.status === 'rejected').length;
        
        document.getElementById('stat-pending-student').textContent = pending;
        document.getElementById('stat-approved-student').textContent = approved;
        document.getElementById('stat-rejected-student').textContent = rejected;
        
        const container = document.getElementById('student-history');
        if (requests.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-400 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
          return;
        }
        
        container.innerHTML = requests.map(req => {
          const statusText = { pending: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', approved: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', rejected: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' }[req.status];
          const statusEmoji = { pending: '‚è≥', approved: '‚úÖ', rejected: '‚ùå' }[req.status];
          return `
            <div class="request-card ${req.status}">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <p class="font-bold text-gray-800">${req.reason}</p>
                  <p class="text-sm text-gray-600">${req.leaveDate} ${req.leaveTime}</p>
                </div>
                <span class="text-xs font-bold">${statusEmoji} ${statusText}</span>
              </div>
              ${req.rejectionNote ? `<p class="text-xs text-red-700 mt-2">üí¨ ${req.rejectionNote}</p>` : ''}
              ${req.photoUrl ? `<div class="mt-3"><img src="${req.photoUrl}" loading="lazy" alt="‡∏£‡∏π‡∏õ‡∏•‡∏≤" class="w-full max-w-xs rounded-lg border border-gray-300 cursor-pointer hover:opacity-80" onclick="openPhotoModal('${req.photoUrl}')" onerror="this.style.display='none';"></div>` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error(error);
      }
    }

    function listenToRequests() {
      if (unsubscribe) unsubscribe();
      unsubscribe = db.collection('leaveRequests')
        .orderBy('createdAt', 'desc')
        .onSnapshot(
          (snap) => {
            allRequests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateStaffView();
          },
          (error) => {
            console.error(error);
            showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
          }
        );
    }

    function updateStaffView() {
      document.getElementById('stat-total').textContent = allRequests.length;
      document.getElementById('stat-pending').textContent = allRequests.filter(r => r.status === 'pending').length;
      document.getElementById('stat-approved').textContent = allRequests.filter(r => r.status === 'approved').length;
      document.getElementById('stat-rejected').textContent = allRequests.filter(r => r.status === 'rejected').length;
      renderRequests();
    }

    function filterRequests(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#374151';
      });
      event.target.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      event.target.style.color = 'white';
      renderRequests();
    }

    function renderRequests() {
      let filtered = currentFilter === 'all' ? allRequests : allRequests.filter(r => r.status === currentFilter);
      const container = document.getElementById('staff-requests');
      
      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 py-12">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>';
        return;
      }
      
      container.innerHTML = filtered.map(req => `
        <div class="request-card ${req.status}">
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <h3 class="font-bold text-gray-800">${req.studentName}</h3>
              <p class="text-sm text-gray-600">${req.studentRoom}</p>
            </div>
            <span class="text-xs font-bold">${req.status === 'pending' ? '‚è≥' : req.status === 'approved' ? '‚úÖ' : '‚ùå'}</span>
          </div>
          <div class="text-sm text-gray-700 space-y-1 mb-3">
            <p><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${req.reason}</p>
            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${req.leaveDate} ${req.leaveTime}</p>
            <p><strong>‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á:</strong> ${req.parentName} ${req.parentPhone}</p>
          </div>
          ${req.photoUrl ? `
            <div class="mb-3 border-t pt-3">
              <p class="font-semibold text-gray-700 mb-2">üì∏ ‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</p>
              <img src="${req.photoUrl}" loading="lazy" alt="‡∏£‡∏π‡∏õ‡∏•‡∏≤" class="w-full max-w-xs rounded-lg border border-gray-300 cursor-pointer hover:opacity-80 transition" onclick="openPhotoModal('${req.photoUrl}')" onerror="this.style.display='none';">
            </div>
          ` : ''}
          ${req.rejectionNote ? `<p class="text-xs bg-red-100 p-2 rounded text-red-700 mb-3">üí¨ ${req.rejectionNote}</p>` : ''}
          ${req.status === 'pending' ? `
            <div class="flex gap-2">
              <button onclick="approveRequest('${req.id}')" class="flex-1 btn-primary btn-approve">‚úì ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button onclick="openRejectionModal('${req.id}')" class="flex-1 btn-primary btn-reject">‚úï ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function openPhotoModal(photoUrl) {
      document.getElementById('modal-photo').src = photoUrl;
      document.getElementById('photo-modal').style.display = 'flex';
    }

    function closePhotoModal() {
      document.getElementById('photo-modal').style.display = 'none';
      document.getElementById('modal-photo').src = '';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.querySelector('.drop-zone').classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('image/')) {
        selectPhotoFile(files[0]);
      } else {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
      }
    }

    function handlePhotoSelect(e) {
      if (e.target.files.length > 0) {
        selectPhotoFile(e.target.files[0]);
      }
    }

    async function selectPhotoFile(file) {
      if (file.size > 10 * 1024 * 1024) {
        showToast('‚ùå ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB', 'error');
        return;
      }

      showToast('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û...');
      
      try {
        const compressedBlob = await compressImage(file);
        photoFile = compressedBlob;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('preview-img').src = e.target.result;
          document.getElementById('photo-preview').style.display = 'block';
          showToast('‚úÖ ‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        };
        reader.readAsDataURL(compressedBlob);
      } catch (error) {
        console.error('Compression error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå', 'error');
        photoFile = null;
      }
    }

    function removePhoto() {
      photoFile = null;
      document.getElementById('photo-preview').style.display = 'none';
      document.getElementById('photo-input').value = '';
      showToast('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
    }

    function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let { width, height } = img;

            if (width > 1200 || height > 1200) {
              const scale = Math.min(1200 / width, 1200 / height);
              width *= scale;
              height *= scale;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(resolve, 'image/jpeg', 0.7);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function submitRequest(e) {
      e.preventDefault();

      if (isSubmitting) {
        showToast('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
        return;
      }

      const btn = document.getElementById('submit-btn');
      isSubmitting = true;
      btn.disabled = true;
      
      try {
        const name = document.getElementById('form-name').value.trim();
        const level = document.getElementById('form-level').value.trim();
        const room = document.getElementById('form-room').value.trim();
        const date = document.getElementById('form-date').value.trim();
        const leaveTime = document.getElementById('form-leave-time').value.trim();
        const parentName = document.getElementById('form-parent-name').value.trim();
        const parentPhone = document.getElementById('form-parent-phone').value.trim();
        const reason = document.getElementById('form-reason').value.trim();

        const errors = [];
        if (!name) errors.push('‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•');
        if (!level) errors.push('‡∏ä‡∏±‡πâ‡∏ô');
        if (!room) errors.push('‡∏´‡πâ‡∏≠‡∏á');
        if (!date) errors.push('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤');
        if (!leaveTime) errors.push('‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å');
        if (!parentName) errors.push('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á');
        if (!parentPhone) errors.push('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
        if (!reason) errors.push('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤');

        if (errors.length > 0) {
          showToast(`‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: ${errors.join(', ')}`, 'error');
          isSubmitting = false;
          btn.disabled = false;
          return;
        }

        const returnTime = document.getElementById('form-return-time').value.trim() || '-';

        btn.innerHTML = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        const requestData = {
          studentId: currentUser.userId,
          studentName: name,
          studentLevel: level,
          studentRoom: `${level}/${room}`,
          parentName: parentName,
          parentPhone: parentPhone,
          reason: reason,
          leaveDate: date,
          leaveTime: leaveTime,
          returnTime: returnTime,
          photoUrl: '',
          status: 'pending',
          rejectionNote: '',
          createdAt: new Date().toISOString()
        };

        const docRef = await db.collection('leaveRequests').add(requestData);
        const docId = docRef.id;

        showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');

        if (photoFile) {
          btn.innerHTML = 'üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...';
          
          try {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 9);
            const fileName = `leave_photos/${currentUser.userId}_${timestamp}_${random}.jpg`;
            
            const uploadTask = storage.ref(fileName).put(photoFile);
            const snapshot = await uploadTask;
            const photoUrl = await snapshot.ref.getDownloadURL();
            
            await db.collection('leaveRequests').doc(docId).update({ photoUrl: photoUrl });
            
            showToast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          } catch (uploadError) {
            console.error('Photo upload error:', uploadError);
            showToast('‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ', 'info');
          }
        }

        btn.innerHTML = 'üéâ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß!';
        
        document.getElementById('student-form').reset();
        removePhoto();
        
        setTimeout(() => {
          btn.innerHTML = 'üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠';
          loadStudentHistory();
        }, 1500);
        
      } catch (error) {
        console.error('Submit error:', error);
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
      } finally {
        isSubmitting = false;
        btn.disabled = false;
      }
    }

    async function approveRequest(id) {
      try {
        await db.collection('leaveRequests').doc(id).update({ status: 'approved' });
        showToast('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
      } catch (error) {
        console.error(error);
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    function openRejectionModal(id) {
      rejectionId = id;
      document.getElementById('rejection-modal').style.display = 'flex';
    }

    function closeRejectionModal() {
      document.getElementById('rejection-modal').style.display = 'none';
      rejectionId = null;
      document.getElementById('rejection-text').value = '';
    }

    async function submitRejection() {
      try {
        const reason = document.getElementById('rejection-text').value.trim();
        if (!reason) {
          showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', 'error');
          return;
        }
        
        if (!rejectionId) {
          showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'error');
          return;
        }

        await db.collection('leaveRequests').doc(rejectionId).update({
          status: 'rejected',
          rejectionNote: reason
        });
        showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        closeRejectionModal();
      } catch (error) {
        console.error(error);
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    selectRole('student');
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cc595f8c68a7329',t:'MTc3MDgzMTE0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
